rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // REGLA PARA USUARIOS
    // FUNCIÓN HELPER para verificar acceso (Cliente dueño O Trabajador autorizado)
    function isAuthorized(clienteId) {
      let isOwner = request.auth.uid == clienteId;
      let isSuperAdmin = request.auth.token.email == 'nelsonsr.1983@gmail.com';
      // let isWorker = get(/databases/$(database)/documents/usuarios/$(request.auth.uid)).data.clienteId == clienteId;
      // Optimización: Chequear worker solo si no es owner ni admin (ahorra lecturas)
      return isOwner || isSuperAdmin || (request.auth.uid != null && get(/databases/$(database)/documents/usuarios/$(request.auth.uid)).data.clienteId == clienteId);
    }

    // REGLA PARA USUARIOS
    match /usuarios/{userId} {
      // Permitir leer/escribir si es el propio usuario
      allow read, write: if request.auth != null && request.auth.uid == userId;
      
      // Permitir creación/gestión si el usuario que hace la petición es el "clienteId" (Jefe)
      // Nota: Para lectura (listas), esto requiere queries que filtren por clienteId
      allow read, write: if request.auth != null && (
        resource.data.clienteId == request.auth.uid || 
        request.resource.data.clienteId == request.auth.uid
      );
      
      // Fallback temporal para permitir la creación inicial
      allow create: if request.auth != null;
    }
    // REGLA PARA CLIENTES
    match /clientes/{clienteId} {
      allow read, write, delete: if request.auth != null && request.auth.token.email == 'admin@tuapp.com';
      allow read, delete: if request.auth != null && resource.data.uid == request.auth.uid;
      allow create, update: if request.auth != null && request.resource.data.uid == request.auth.uid;
    }
    // REGLA PARA PERFILES DE CARGO
    match /perfiles_cargo/{perfilId} {
      allow read, delete: if request.auth != null && isAuthorized(resource.data.clienteId);
      allow create, update: if request.auth != null && isAuthorized(request.resource.data.clienteId);
    }
    // REGLA PARA TRABAJADORES
    match /trabajadores/{trabajadorId} {
      allow read, delete: if request.auth != null && isAuthorized(resource.data.clienteId);
      allow list: if request.query.limit <= 1; // Permitir buscar trabajador por cédula (limitado)
      allow create, update: if request.auth != null && isAuthorized(request.resource.data.clienteId);
    }
    // REGLA PARA NOVEDADES
    match /novedades/{novedadId} {
      allow read, delete: if request.auth != null && isAuthorized(resource.data.clienteId);
      allow create, update: if request.auth != null && isAuthorized(request.resource.data.clienteId);
    }
    
    // REGLA PARA EMOS
    match /emos/{emoId} {
      allow read, delete: if request.auth != null && isAuthorized(resource.data.clienteId);
      allow create, update: if request.auth != null && isAuthorized(request.resource.data.clienteId);
    }
    // REGLA PARA ENCUESTAS DE SALUD
    match /encuestas_salud/{encuestaId} {
      allow read, delete: if request.auth != null && isAuthorized(resource.data.clienteId);
      allow list: if request.query.limit <= 20; // Permitir al portal listar encuestas activas (limitado)
      allow create, update: if request.auth != null && isAuthorized(request.resource.data.clienteId);
    }
    // REGLA PARA RESPUESTAS DE ENCUESTAS
    match /respuestas_encuestas/{respuestaId} {
      allow read, delete: if request.auth != null && resource.data.clienteId == request.auth.uid;
      allow read, create, update: if true; // Ya estaba abierto, mantenemos
      allow delete: if request.auth != null && resource.data.clienteId == request.auth.uid;
    }
    // REGLA PARA ANÁLISIS DE ENCUESTAS
    match /analisis_encuestas/{analisisId} {
      allow read, delete: if request.auth != null && resource.data.clienteId == request.auth.uid;
      allow create, update: if request.auth != null && request.resource.data.clienteId == request.auth.uid;
    }
    // --- NUEVAS REGLAS PARA MÓDULO DE RECARGOS ---
    match /parametros_recargos/{document} {
      allow read, write: if request.auth != null; // Se puede refinar si es necesario
    }
    match /recargos_laborales/{document} {
      allow read, delete: if request.auth != null && isAuthorized(resource.data.clienteId);
      allow create, update: if request.auth != null && isAuthorized(request.resource.data.clienteId);
    }
    match /inventarios/{document=**} {
      // Permitir lectura si está autorizado
      allow read: if request.auth != null && (
        isAuthorized(resource.data.clienteId) || 
        resource.data.clienteId == request.auth.uid // Fallback directo
      );
      // Escritura restringida
      allow create, update, delete: if request.auth != null && isAuthorized(resource.data.clienteId);
      allow create: if request.auth != null && isAuthorized(request.resource.data.clienteId);
    }
    match /catalogo_global_activos/{document=**} {
       allow read, write: if request.auth != null; // Catálogo global puede ser abierto
    }
    // Permitir gestión de plantillas
    match /plantillas_documentos/{document=**} {
       allow read, write: if request.auth != null;
    }
    // Permitir guardar los documentos generados
    match /repositorio_documentos/{document=**} {
      allow read, delete: if request.auth != null && isAuthorized(resource.data.clienteId);
      allow create, update: if request.auth != null && isAuthorized(request.resource.data.clienteId);
    }
    // Regla ESPECÍFICA para Inspecciones SST
    match /inspecciones_sst/{document} {
      allow read, delete: if request.auth != null && isAuthorized(resource.data.clienteId);
      allow create, update: if request.auth != null && isAuthorized(request.resource.data.clienteId);
    }
    match /mantenimientos_vehiculos/{document} {
      allow read, delete: if request.auth != null && isAuthorized(resource.data.clienteId);
      allow create, update: if request.auth != null && isAuthorized(request.resource.data.clienteId);
    }

    // --- NUEVA REGLA PARA INSPECCIONES PREOPERACIONALES ---
    match /inspecciones_preoperacionales/{document} {
      allow read, delete: if request.auth != null && isAuthorized(resource.data.clienteId);
      allow create: if request.auth != null && isAuthorized(request.resource.data.clienteId);
      allow update: if request.auth != null && (isAuthorized(request.resource.data.clienteId) || request.auth.token.email == 'nelsonsr.1983@gmail.com');
    }
  }
}
